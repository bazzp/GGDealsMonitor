<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Monitor cen gier</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #threshold-modal {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index:1000
    }
    #threshold-modal > div {
      background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px #0008;
      display: flex; flex-direction: column; gap: 8px; min-width: 240px;
      align-items: stretch;
    }
  </style>
</head>
<body>
<h1>Monitor cen gier</h1>
<form class="add-form" id="addForm">
  <input type="text" id="urlInput" placeholder="Wklej link do gry z GG.deals, np. https://gg.deals/game/minecraft/" required>
  <input type="number" id="thresholdInput" placeholder="Pr√≥g powiadomienia (z≈Ç)">
  <button type="submit">Dodaj</button>
</form>
<table id="gamesTable">
  <thead>
  <tr>
    <th>Nazwa gry</th>
    <th>Oficjalny sklep (z≈Ç)</th>
    <th>Keyshop (z≈Ç)</th>
    <th>Link</th>
    <th>Pr√≥g powiadomienia (z≈Ç)</th>
    <th style="width:80px;"></th>
  </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- MODAL DO EDYCJI PROGU -->
<div id="threshold-modal">
  <div>
    <label>Nowy pr√≥g cenowy:
      <input type="number" id="threshold-modal-input">
    </label>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="threshold-modal-ok">OK</button>
      <button id="threshold-modal-cancel">Anuluj</button>
    </div>
  </div>
</div>

<script>
  const ipcRenderer = window.electron.ipcRenderer;

  function updateTable(games) {
    const tbody = document.querySelector('#gamesTable tbody');
    tbody.innerHTML = '';
    games.forEach((game, i) => {
      const official = (game.official !== null && game.official !== undefined) ? game.official : '-';
      const keyshop = (game.keyshop !== null && game.keyshop !== undefined) ? game.keyshop : '-';
      const threshold = (game.threshold !== null && game.threshold !== undefined && game.threshold !== "") ? game.threshold : '-';
      const row = document.createElement('tr');
      row.innerHTML = `
          <td>${game.name}</td>
          <td>${official}</td>
          <td>${keyshop}</td>
          <td><a class="games-link" href="${game.url}" target="_blank">GG.deals</a></td>
          <td id="threshold-${i}">${threshold}</td>
          <td>
           <button data-index="${i}" class="edit-btn" title="Edytuj pr√≥g">‚úèÔ∏è</button>
           <button data-index="${i}" class="remove-btn" title="Usu≈Ñ">üóëÔ∏è</button>
          </td>
        `;
      tbody.appendChild(row);
    });

    // Obs≈Çuga klikniƒôcia usu≈Ñ
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.onclick = function () {
        const idx = parseInt(this.getAttribute('data-index'));
        ipcRenderer.send('remove-game', idx);
      };
    });

    // Obs≈Çuga klikniƒôcia edytuj
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.onclick = function () {
        editIdx = parseInt(this.getAttribute('data-index'));
        const current = document.getElementById('threshold-' + editIdx).innerText;
        document.getElementById('threshold-modal').style.display = 'flex';
        document.getElementById('threshold-modal-input').value = (current === '-' ? '' : current);
        document.getElementById('threshold-modal-input').focus();
      };
    });
  }

  // Odbi√≥r zaktualizowanej listy gier
  ipcRenderer.on('games', (event, games) => {
    updateTable(games);
  });

  // Dodawanie gry
  document.getElementById('addForm').onsubmit = function(e) {
    e.preventDefault();
    const url = document.getElementById('urlInput').value.trim();
    const threshold = document.getElementById('thresholdInput').value.trim();
    if (url) {
      ipcRenderer.invoke('add-game', url, threshold);
      document.getElementById('urlInput').value = '';
      document.getElementById('thresholdInput').value = '';
    }
  };

  // Za≈Çaduj gry przy starcie
  window.onload = function() {
    ipcRenderer.send('get-games');
  };

  // MODAL: obs≈Çuga edycji progu
  let editIdx = null;
  document.getElementById('threshold-modal-ok').onclick = function() {
    const newVal = document.getElementById('threshold-modal-input').value.trim();
    if (editIdx !== null) {
      ipcRenderer.invoke('edit-threshold', editIdx, newVal);
    }
    document.getElementById('threshold-modal').style.display = 'none';
    editIdx = null;
  };
  document.getElementById('threshold-modal-cancel').onclick = function() {
    document.getElementById('threshold-modal').style.display = 'none';
    editIdx = null;
  };
</script>
</body>
</html>